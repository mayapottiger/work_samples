---
title: "Public Housing Evictions Factcheck"
author: "Maya Pottiger, Ryan Little, Nick McMillan, Rina Torchinsky, Philip Van Slooten and Amy DiPierro"
date: "12/4/2020"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    highlight: pygments
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

This data notebook contains the analysis that generated facts in the story [LINK](http://google.com).  For each sentence in the story generated by original data analysis, we have provided the corresponding code and results. 

## Load Libraries

Code to load necessary libraries. Click "Code" button to view.

```{r message=FALSE, warning=FALSE}

# For general data science
library(tidyverse)
# For data cleaning
library(janitor)
# For loading Excel files
library(readxl)
# For working with date
library(lubridate)
# For pretty tables
library(kableExtra)
library(knitr)
# For census data
library(tidycensus)
# For aws buckets
library(aws.s3)

# Define API Key for Tidycensus
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

```

## Load and Clean Data

For this project, we examined evictions by local public housing authorities in several cities.  

Using data from the U.S. Census Bureau, the Eviction Lab at Princeton University, the U.S. Department of Housing and Urban Development and local court records, we identified nearly two dozen communities that scored high on more than one of the following dimensions: high historical eviction-filing rates, high rents relative to income, high homeless rates, ease of access to eviction court records and a public-housing authority that was among the leading evictors. Through reporting and research, we narrowed our focus to those five places described in the story. 

The cities were:

* Charleston, South Carolina
* Crisfield, Maryland
* Minneapolis, Minnesota
* Oklahoma City, Oklahoma
* Richmond, Virginia 


To analyze evictions, we acquired several different data sources in each of these locations.  

* Court records obtained from online court record management systems using custom web scraping software written in Python. We cleaned the data using R and Open Refine.
* Internal public housing authority documents and spreadsheets that detailed evictions. For records that were provided as PDFs, we used Adobe Acrobat, Tabula and other software tools to extract data.  
  * Charleston: The Housing Authority of the City of Charleston sent a spreadsheet with yearly breakdowns of all tenant moveouts from 2015-2020. The sheets included an entity identifier for each tenant, street address, unit number and number of bedrooms. It also included the move-in and move-out dates, as well as the reason for moving out, which included evictions.
  * Crisfield: While we did not receive documents directly from the Housing Authority of Crisfield, we obtained records from an attorney representing the housing authority that showed cases filed by eWrit Filings, an outside contractor the housing authority uses to file evictions. The eWrit documents included case numbers, tenant names, tenant address, the tenants' rent, late fee, amount due, suit month and trial date. The records are from 2018-2020, as the housing authority started filing with eWrit in June 2018.
  * Minneapolis: The Minneapolis Public Housing Authority sent internal eviction records and a log of tenants who entered into payment agreements. The internal evictions records included tenant names, tenant dates of birth, entity IDs unique to tenants, unit IDs unique to the units, case numbers, street addresses, amount owed at filing, monthly rent, court fee and service fee. The payback agreements included the date filed, case number, who signed off on the agreement, and the amount owed at each payment installment, the day it was due and whether it was paid.
  * Oklahoma City: The Oklahoma City Housing Authority sent internal move out records that included the case number, tenant name, tenant race, property code, file date, settle date, move out reason, judgement and whether a writ was served. It also included the rent per month and amount owed. 
  * Richmond: The Richmond Redevelopment and Housing Authority sent internal move out records. The records included move in date, move out date, number of days the tenant lived in the unit, move out reason, address and property name.
  
Code to load and clean necessary data. Click "Code" button to view.

```{r warning=FALSE, message=FALSE}

# All data for Charleston analysis
charleston_pha_all <- read_csv("cha_cases_1205.csv") # scraped Charleston court data, filtered for housing authority cases
charleston_all <- read.csv("charleston_all_clean.csv") # all scraped Charleston court data for question about rank

# All data for Crisfield analysis
crisfield_ewrit <- read_csv("crisfield_ewrit_all_1204.csv") # records from eWrit Filings, an outside contractor that automates the process
# Crisfield ewrit cleaning
crisfield_ewrit<- crisfield_ewrit %>%
  mutate(case_number = tolower(case_number)) %>%
  mutate(case_number = str_remove_all(case_number,"absolute| absolute|-|none")) %>%
  mutate(case_number = str_trim(case_number, side="both")) %>%
  filter(case_number != "") %>%
  distinct(case_number, .keep_all = TRUE)
#Adding ryan somerset case rescrape from Sat Dec. 5
somerset <- read_csv("somerset-sequential-rescrape.csv") %>%
  bind_rows(read_csv("somerset-missing-rescrape.csv")) %>%
  mutate(filing_date = mdy(filing_date)) %>%
  mutate(year = year(filing_date)) %>%
  filter(str_detect(case_type,"failure to pay rent|tenant holding over|wrongful detainer|breach of lease")) %>%
  rename(plaintiff = landlord) 

#All data for OKC analysis
okc <- read.csv("okc_rescrape_nov_2015-2020.csv") %>% # scraped OKC court data
  filter(str_detect(case_type,"forcible entry")) %>%
  mutate(file_date = mdy(file_date)) %>%
  mutate(year = year(file_date)) 
okc_rent <- read.csv("okc_rent.csv") # OKC rent records from the housing authority
okc_records <- read.csv("okc_pha_final_1204.csv") # all records from the OKC housing authority
# cleaning OKC records
okc_records <- okc_records %>%
  mutate(short_case_number = case_number) %>%
  mutate(case_number = paste0('sc-', year, '-', short_case_number),
         pha_file_date = file_date,
         pha_judgment = judgement,
         pha_writ = writ
         ) %>%
  inner_join(okc, by="case_number")

#All data for Minneapolis analysis
minneapolis <- read.csv("hennepin_1202_pha.csv") # scraped Minneapolis court data, filtered for housing authority cases, updated 12/2
minneapolis_all_cases <- read.csv("minneapolis_all_cases.csv") %>% # all scraped Minneapolis court data for question about rank
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed))
minneapolis_eviction_records <- read_xlsx("minn_rent_filings_FINAL.xlsx") %>% # records from Minneapolis PHA about nonpayment cases
  mutate(case_number = tolower(case_number))

#All data for Richmond analysis
richmond <- read.csv("richmond_ha_clean.csv") # scraped Richmond court data, filtered for housing authority cases, updated 12/2
richmond_records <- read.csv("df.final_richmond.csv") # all Richmond records from the housing authority

# Create list of CoCs 
coc_list <- c("MD-513","SC-500","MN-500","VA-500","OK-502")

# Read in Zillow inflection homeless study
coc_rate <- read_csv("https://raw.githubusercontent.com/G-Lynn/Inflection/master/CoC_Cluster.csv") %>%
  clean_names() %>%
  mutate(nat_avg_homeless_rate = mean(estimated_homeless_rate_percent)) %>%
  filter(co_c_number %in% coc_list) %>%
  select(co_c_number, co_c_name, homeless_rate = estimated_homeless_rate_percent, nat_avg_homeless_rate)

# Create list of county fips codes
county_list <- c("45019","24039","27053","51760","40109")

# Get by income Median Gross Rent as Percent of Household Income

median_gross_rent_as_pct_household_income <- get_acs(geography = "county",
              variables = c("B25071_001"), geometry = FALSE, year=2018) %>%
              rename(median_gross_rent_as_pct_household_income = estimate) %>%
              select(-variable, -moe) %>%
              filter(!is.na(median_gross_rent_as_pct_household_income)) %>%
              mutate(nat_avg_median_gross_rent_as_pct_household_income = mean(median_gross_rent_as_pct_household_income)) %>%
              filter(GEOID %in% county_list)

# Crosswalk

crosswalk <- tribble(
  ~co_c_number, ~fips,
  "MD-513","24039",
  "MN-500","27053",
  "SC-500","45019",
  "VA-500","51760",
  "OK-502","40109"
)

## Get eviction data 
state <- "US"
# Define path to S3 eviction lab bucket and get it
object_path <- paste0(state,"/counties.csv")
object <- get_object(object_path, bucket = "eviction-lab-data-downloads")
# Read in data from bucket and conenct 
to_character <- rawToChar(object)
connection <- textConnection(to_character)
evictions <- read.csv(connection)
close(connection)

# Filter to only get 2016 eviction filings and filing rate, plus additional cleaning
evictions_2016 <- evictions %>%
  filter(year == 2016) %>%
  as_tibble() %>%
  mutate(GEOID = as.character(GEOID)) %>%
  mutate(GEOID = str_pad(GEOID, width=5, side="left", pad="0")) %>%
  select(county_fips = GEOID, cty_eviction_filings_2016 = eviction.filings, cty_evictions_2016 = evictions, cty_eviction_filing_rate_2016 = eviction.filing.rate, cty_eviction_rate_2016 = eviction.rate, cty_rent_burden_2016 = rent.burden, cty_pct_rent_occupied_2016 = pct.renter.occupied) %>%
  select(county_fips, cty_eviction_filing_rate_2016, cty_eviction_rate_2016) %>%
  filter(!is.na(cty_eviction_filing_rate_2016)) %>%
  filter(!is.na(cty_eviction_rate_2016)) %>%
  mutate(avg_eviction_filing_rate = mean(cty_eviction_filing_rate_2016),
         avg_eviction_rate = mean(cty_eviction_rate_2016)) %>%
  select(-avg_eviction_rate, -cty_eviction_rate_2016) %>%
  filter(county_fips %in% county_list)

# Bind homeless, rent burden and eviction data together

local_stats <- coc_rate %>%
  inner_join(crosswalk) %>%
  inner_join(median_gross_rent_as_pct_household_income, by=c("fips" = "GEOID")) %>%
  left_join(evictions_2016, by=c("fips"="county_fips")) %>%
  select(fips, name=NAME, homeless_rate, nat_avg_homeless_rate, median_gross_rent_as_pct_household_income, nat_avg_median_gross_rent_as_pct_household_income, eviction_filing_rate = cty_eviction_filing_rate_2016, nat_avg_eviction_filing_rate = avg_eviction_filing_rate)

```

## Story Fact Check

### Crisfield 

**Sentence:** "But in Crisfield, a city of 2,600 on the Chesapeake Bay, the housing authority is one of the leading eviction filers."

**Discussion:** The Housing Authority of Crisfield accounted for 1,756 of 8,335 filings in Somerset County Maryland between Jan. 1, 2017 and Nov. 30, 2020 -- or about 1 in 5 filings. By that measure, they are among the most active in the county.  


```{r warning=FALSE, message=FALSE}

# count of Crisfield housing authority cases 

crisfield_housing_authority <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(plaintiff) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  summarise(total_cha = sum(total))

# Count of all cases 
somerset_all_cases <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  summarise(total_filings = n())

# All cases by plaintiffs
somerset_all_plaintiffs <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  group_by(plaintiff) %>%
  summarise(total = n()) %>%
  arrange(desc(total))

```


**Sentence:** "The agency owns just 330 units yet filed 718 times in 2019, all over late rent."


```{r warning=FALSE, message=FALSE}

cha_2019_filing_ct <- somerset %>%
  filter(year == 2019) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  count()

cha_2019_filing_type <- somerset %>%
  filter(year == 2019) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(case_type) %>%
  count()

```


**Sentence:** "In nearly 30% of those cases, records show, tenants owed less than $100."


```{r warning=FALSE, message=FALSE}

# Filter 2019 cases and join to ewrit dat
cha_2019_case_less_100_pct <- somerset %>%
  filter(year == 2019) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  select(case_number) %>%
  left_join(crisfield_ewrit) %>%
  filter(!is.na(X1)) %>%
  mutate(amount_due_category = case_when(
    amount_due < 100 ~ "less_than_100",
    TRUE ~ "greater_than_or_equal_to_100"
  )) %>%
  group_by(amount_due_category) %>%
  summarise(total_cases = n()) %>%
  pivot_wider(names_from=amount_due_category, values_from=total_cases) %>%
  mutate(total_cases=less_than_100+greater_than_or_equal_to_100) %>%
  mutate(pct_less_than_100 = round(less_than_100/total_cases*100,2)) %>%
  select(pct_less_than_100)

```


**Sentence:** "The Housing Authority of Crisfield has filed 1,756 evictions since 2017, all for failure to pay rent."


```{r warning=FALSE, message=FALSE}

crisfield_housing_authority_all <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(plaintiff) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  summarise(total_cha = sum(total))

cha_filing_type_all <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  mutate(case_type = str_remove_all(case_type," - mobile home")) %>%
  group_by(case_type) %>%
  count() 

```


**Sentence:** "The annual count more than tripled from 207 in 2017 to 718 last year..."


```{r warning=FALSE, message=FALSE}

# group by file year to compare annual filing numbers

cha_by_year <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(year) %>%
  count()

```


**Sentence:** "Although the records are not clear on all of the outcomes, it appears most settled up or left on their own. However, records indicate that approximately 50 households were forcibly removed — with about half occurring since the beginning of 2019."


```{r warning=FALSE, message=FALSE}

crisfield_households_removed <- somerset %>%
  filter(year > 2016) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  filter(warrant_outcome == "evicted") %>%
  select(case_number, warrant_outcome, year) %>%
  group_by(year) %>%
  count()

```


**Sentence:** "In Crisfield, Tawna Renee Thomas, 26, received her first eviction filing in March 2018...In total, Thomas received five eviction filings in an 18-month period, according to court records...She hasn’t been served an eviction notice so far in 2020..."


```{r warning=FALSE, message=FALSE}

tawna_thomas <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  filter(str_detect(tenant, "tawna")) %>%
  arrange(filing_date)

```

### Charleston

**Sentence:** "The Housing Authority of the City of Charleston manages 1,753 units and averages nearly 1,200 eviction filings each year, making it one of the county’s leading eviction filers."


```{r warning=FALSE, message=FALSE}

# create a year column from the date_filed column

charleston_pha_year <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016","2020")) %>%
  group_by(year) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  summarise(yearly_average = mean(total))

# use charleston_all to find rank of housing authority in terms of all plaintiffs -- also note that Magnolia Downs is a property owned by the housing authority

charleston_rank <- charleston_all %>%
  group_by(plaintiff_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total))
  
```


**Sentence:** "It’s common for the housing authority to file multiple eviction cases against the same tenant year after year, and at times within months of each other. Three tenants each had 16 cases against them since 2017, with filings every few months."


```{r warning=FALSE, message=FALSE}

# using PHA case list, grouping by defendant name and arranging in descending order

charleston_pha_defendants <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(defendant_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  filter(total > 2) %>%
  summarise(total_multiple_defendants = n())

top_multiple_defendant <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(defendant_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  filter(total == max(total)) %>%
  inner_join(charleston_pha_all) %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  arrange(defendant_one_name, date_filed) %>%
  group_by(defendant_one_name) %>%
  count()

```

### Minneapolis

**Sentence:** The Minneapolis Public Housing Authority, which owns and operates nearly 6,000 low-income housing units, is its county’s largest landlord and a leading eviction filer.


```{r warning=FALSE, message=FALSE}

# group all plaintiffs, summarise and arrange in descending order based on the total

minneapolis_rank <- minneapolis_all_cases %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(plaintiff_name_one) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  head(10)

```


**Sentence:** "It initiated 1,087 evictions for nonpayment of rent, accounting for 87% of its filings."


```{r warning=FALSE, message=FALSE}

# filtering for cases after 2017

minneapolis_after_2017 <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) 

# seeing which HA records are not in court records

not_in_court_records <- minneapolis_eviction_records %>%
  anti_join(minneapolis_after_2017, by=c("case_number")) %>%
  mutate(case_type = "non_payment_rent") %>%
  select(case_number, case_type)

# seeing which records are in both HA and court

in_both <- minneapolis_eviction_records %>%
  inner_join(minneapolis_after_2017, by=c("case_number")) %>%
  mutate(case_type = "non_payment_rent") %>%
  select(case_number, case_type)

# which court records are not in HA records

not_in_ha_data <- minneapolis_after_2017 %>%
  anti_join(minneapolis_eviction_records, by=c("case_number")) %>%
  mutate(case_type = "other") %>%
  select(case_number, case_type)

# adding total and finding percent

case_type_combined <- not_in_court_records %>%
  bind_rows(in_both) %>%
  bind_rows(not_in_ha_data) %>%
  group_by(case_type) %>%
  count() %>%
  pivot_wider(names_from = case_type, values_from=n) %>%
  mutate(total = non_payment_rent+other) %>%
  mutate(pct_nonpayment = round(non_payment_rent/total*100,2))

```


### Oklahoma City

**Sentence:** "The Oklahoma City Housing Authority, with 2,913 public-housing units, filed more than 600 cases, resulting in more than 500 households being forced out."


```{r warning=FALSE, message=FALSE}

# create case number in okc records

okc_records_count <- okc_records %>%
  filter(year.x > 2016) %>%
  mutate(writ_executed = case_when(
    writ_executed == "none" ~ "writ_not_executed",
    TRUE ~ "writ_executed"
  )) %>%
  group_by(writ_executed) %>%
  count() %>%
  pivot_wider(names_from = writ_executed, values_from=n) %>%
  mutate(total = writ_executed+writ_not_executed)

okcha_count <- okc %>%
  filter(str_detect(plaintiff_one,"housing authority"))

```


**Sentence:** "More than half were rent-related."


```{r warning=FALSE, message=FALSE}

# group by the "reason_type" column Bryan and Philip made from the OKC records, which categorized each case as "financial" or "other"

okc_reason_count <- okc_records %>%
  filter(year.x > 2016) %>%
  mutate(writ_executed = case_when(
    writ_executed == "none" ~ "writ_not_executed",
    TRUE ~ "writ_executed"
  )) %>%
  group_by(writ_executed, reason_type) %>%
  filter(writ_executed == "writ_executed") %>%
  summarise(total = n()) %>%
  arrange(desc(total))

```

### Richmond

**Sentence:** "The Richmond Redevelopment and Housing Authority, with 3,572 public-housing units, took tenants to court more than 4,100 times."


```{r warning=FALSE, message=FALSE}

# total number of cases from Richmond, which is already filtered for PHA cases
richmond_count <- richmond %>%
  filter(file_year > 2016) %>%
  count()

```


**Sentence:** "The housing authority won judgments in 2,075 of those cases — one in six of which was over debts of less than $100."


```{r warning=FALSE, message=FALSE}

richmond_judgments <- richmond  %>%
  filter(file_year > 2016) %>%
  group_by(judgment_for) %>%
  count() %>%
  arrange(desc(n))

# format amount_due column
richmond_under_pct <- richmond %>%
  filter(file_year > 2016) %>%
  filter(principal_amount > 0) %>%
  mutate(principal_amount_category = case_when(
    principal_amount < 100 ~ "less_than_100",
    TRUE ~ "greater_than_or_equal_to_100"
  )) %>%
  group_by(principal_amount_category) %>%
  count() %>%
  pivot_wider(names_from=principal_amount_category, values_from=n) %>%
  mutate(total = less_than_100+greater_than_or_equal_to_100) %>%
  mutate(pct_less_than_100 = round(less_than_100/total*100,2))

```

### General

**Sentence:** "Late rent payments were the leading reason they sought to evict their tenants, who are only living in public housing because they’re struggling to make ends meet. Those filings far exceeded evictions over criminal activity, which have received much more public attention."


```{r warning=FALSE, message=FALSE}

#crisfield

crisfield_late_rent <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  mutate(case_type = str_remove_all(case_type," - mobile home")) %>%
  group_by(case_type) %>%
  count() %>%
  mutate(location = "crisfield")

okc_late_rent <- okc_records %>%
  filter(year.x > 2016) %>%
  group_by(reason_type) %>%
  count() %>%
  mutate(location = "okc") %>%
  arrange(desc(n))

#richmond

richmond_late_rent <- richmond_records %>%
  filter(move_out_year > 2016) %>%
  group_by(reason_for_move_out) %>%
  count() %>%
  arrange(desc(n)) %>%
  mutate(location = "richmond")

```


**Sentence:** "Federal and state restrictions during the pandemic have temporarily slowed the pace of rent-related eviction filings, records show, but haven’t halted them."


```{r warning=FALSE, message=FALSE}

# Charleston

yearly_charleston <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(year) %>%
  summarise(total = n()) %>%
  mutate(location = "charleston") %>%
  select(location, everything())

# Crisfield

yearly_crisfield <- somerset %>%
  filter(year > 2016) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(year) %>%
  summarise(total = n()) %>%
  mutate(location = "crisfield") %>%
  select(location, everything())

# Minneapolis

yearly_minneapolis <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  group_by(year) %>%
  summarise(total = n()) %>%
  mutate(location = "minneapolis") %>%
  select(location, everything())

# OKC

yearly_okc <- okcha_count %>%
  filter(year > 2016) %>%
  group_by(year) %>%
  summarise(total = n()) %>%
  mutate(location = "okc") %>%
  select(location, everything())

# Richmond

yearly_richmond <- richmond %>%
  filter(file_year > 2016) %>%
  group_by(file_year) %>%
  summarise(total = n()) %>%
  mutate(location = "richmond") %>%
  select(location, everything())

```


**Sentence:** "The five, which manage more than 14,500 units in total -- took tenants to eviction court more than 11,400 times from 2017 through 2020."


```{r warning=FALSE, message=FALSE}

# create dataframe with location name and count for each county

pha_count_charleston <- charleston_pha_all %>%
  mutate(date_filed = ymd(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  count() %>%
  mutate(location = "charleston") %>%
  rename("total_pha_cases" = "n") %>%
  select(location, total_pha_cases)
  
pha_count_crisfield <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  count() %>%
  mutate(location = "crisfield") %>%
  rename("total_pha_cases" = "n") %>%
  select(location, total_pha_cases)
  
pha_count_minneapolis <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  count() %>%
  mutate(location = "minneapolis") %>%
  rename("total_pha_cases" = "n") %>%
  select(location, total_pha_cases)
  
pha_count_okc <- okcha_count %>%
  filter(year > 2016) %>%
  count() %>%
  mutate(location = "okc") %>%
  rename("total_pha_cases" = "n") %>%
  select(location, total_pha_cases)
  
pha_count_richmond <- richmond %>%
  filter(file_year > 2016) %>%
  count() %>%
  mutate(location = "richmond") %>%
  rename("total_pha_cases" = "n") %>%
  select(location, total_pha_cases)

# bind all counties together and add total

total_pha_eviction_cases <- pha_count_charleston %>%
  bind_rows(pha_count_crisfield) %>%
  bind_rows(pha_count_minneapolis) %>%
  bind_rows(pha_count_okc) %>%
  bind_rows(pha_count_richmond) %>%
  pivot_wider(names_from = location, values_from=total_pha_cases) %>%
  mutate(total = charleston+crisfield+minneapolis+okc+richmond) 

```


**Sentence:** "An eviction order allows physical removal of residents and their possessions by the sheriff’s office, but tenants may  pay up or leave on their own before that happens. However, records indicated the courts authorized removal of at least 2,500 households."

**Discussion:** The analysis identified at least 2,584 eviction cases in which the courts gave housing authorities permission to remove tenants.


```{r warning=FALSE, message=FALSE}

# Charleston
# can use housing authority records
charleston_evictions <- charleston_pha_all %>%
  mutate(date_filed = ymd(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  filter(case_status == "Writ of Ejectment") %>%
  count() %>%
  rename("total_writs" = "n") %>%
  mutate(location = "charleston") %>%
  ungroup() %>%
  select(location, total_writs)

# Crisfield 
# can use warrant_outcome from court records
crisfield_evictions <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  mutate(writ_issued = case_when(
    warrant_ordered == "none" ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(writ_issued) %>%
  count() %>%
  rename("total_writs" = "n") %>%
  mutate(location = "crisfield") %>%
  filter(writ_issued == "yes") %>%
  ungroup() %>%
  select(location, total_writs)

# Minneapolis
# can use writ_of_recovery from court records

minneapolis_evictions <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  mutate(writ_issued = case_when(
    writ_of_recovery == "none" ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(writ_issued) %>%
  count() %>%
  filter(writ_issued == "yes") %>%
  rename("total_writs" = "n") %>%
  mutate(location = "minneapolis") %>%
  ungroup() %>%
  select(location, total_writs)

# OKC
# can use writ_executed from court records

okc_evictions <- okcha_count %>%
  filter(year > 2016) %>%
  mutate(evicted = case_when(
    writ_to_marshall == "none" ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(evicted) %>%
  count() %>%
  filter(evicted == "yes") %>%
  rename("total_writs" = "n") %>%
  mutate(location = "okc") %>%
  ungroup() %>%
  select(location, total_writs)

# Richmond
# using a combination of posession and writ_issued from court records

richmond_evictions <- richmond %>%
  filter(file_year > 2016) %>%
  mutate(evicted = case_when(
    writ_issued == "no" ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(evicted) %>%
  count() %>%
  filter(evicted == "yes") %>%
  rename("total_writs" = "n") %>%
  mutate(location = "richmond") %>%
  ungroup() %>%
  select(location, total_writs)

# bind together

all_writs_issued <- charleston_evictions %>%
  bind_rows(crisfield_evictions) %>%
  bind_rows(minneapolis_evictions) %>%
  bind_rows(okc_evictions) %>%
  bind_rows(richmond_evictions) %>%
  pivot_wider(names_from = location, values_from=total_writs) %>%
  mutate(total = charleston+crisfield+minneapolis+okc+richmond) 
  
```


**Sentence:** "They place the onus on tenants, who typically lack legal representation, to prove they can’t pay due to COVID-19."


```{r warning=FALSE, message=FALSE}

# minneapolis
# need two conditions for this because it could say "none" or "pro se" in defendant_attorney_one
minneapolis_representation <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  mutate(defendant_has_rep = case_when(
    defendant_attorney_one == "none" ~ "no",
    defendant_attorney_one == "pro se" ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(defendant_has_rep) %>%
  count() %>%
  mutate(location = "minneapolis") %>%
  select(location, everything())

# okc
# attorney_two_rep only has two cases, and attorney_three_rep is only "none"

okcha_rep <- okcha_count %>%
  filter(year > 2016) %>%
  mutate(attorney_yes_no = case_when(
    str_detect(attorney_one_rep, "housing") ~ "no",
    attorney_one_rep == "none" ~ "no",
    is.na(attorney_one_rep) ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(attorney_yes_no) %>%
  count() %>%
  mutate(location = "okc") %>%
  select(location, everything())
  
# richmond
richmond_rep <- richmond %>%
  filter(file_year > 2016) %>%
  mutate(defendant_has_rep = if_else(defendant_attorney_one == "none", "no", "yes")) %>%
  group_by(defendant_has_rep) %>%
  count() %>%
  mutate(location = "richmond") %>%
  select(location, everything())

```

## Graphics Fact Check

### Mainbar Slider

For the graphic in the mainbar, we asked the same questions of all four housing authorities to show in one place: 
*How many cases were over nonpayment of rent? 
*What percentage of all cases was that? 
*Of those cases, how many fall into buckets of dollar amounts 0-100, 101-200, 201-300, 301-400 and 401-500?
*What was the average amount owed?
*What percent of defendants had attorneys?

#### Crisfield

``` {r}

#How many cases were over nonpayment of rent? 

cha_nonpayment_graphic <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  mutate(case_type = str_remove_all(case_type," - mobile home")) %>%
  group_by(case_type) %>%
  count() 

#what percentage of all cases was that? 
# all cases

#Of those cases, how many fall into buckets of dollar amounts?

crisfield_buckets_graphic <- crisfield_ewrit %>%
  mutate(amount_due_bucket = case_when(
    amount_due == 0 ~ "N/A",
    amount_due >= 1 & amount_due < 100 ~ 'under_100',
    amount_due >= 100 & amount_due < 200 ~ 'under_200',
    amount_due >= 200 & amount_due < 300 ~ 'under_300',
    amount_due >= 300 & amount_due < 400 ~ 'under_400',
    amount_due >= 400 & amount_due < 500 ~ 'under_500',
    TRUE ~ "500_plus"
  )) %>%
  group_by(amount_due_bucket) %>%
  count()

#What was the average amount owed?

crisfield_amt_owed_avg_graphic <- crisfield_ewrit %>%
  summarise(avg_owed = round(mean(amount_due)))

#What percent of defendants had attorneys?
# don't have this info for Crisfield

```

#### Minneapolis

``` {r}

#How many cases were over nonpayment of rent? 

minn_nonpayment_total <- minneapolis_eviction_records %>%
  filter(!case_number == "n/a") %>%
  filter(!case_number == "deceased/no service")

#what percentage of all cases was that? 

minneapolis_avg_all_graphic <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) 

not_in_court_records <- minneapolis_eviction_records %>%
  anti_join(minneapolis_avg_all_graphic, by=c("case_number")) %>%
  mutate(case_type = "non_payment_rent") %>%
  select(case_number, case_type)

in_both <- minneapolis_eviction_records %>%
  inner_join(minneapolis_avg_all_graphic, by=c("case_number")) %>%
  mutate(case_type = "non_payment_rent") %>%
  select(case_number, case_type)

not_in_ha_data <- minneapolis_avg_all_graphic %>%
  anti_join(minneapolis_eviction_records, by=c("case_number")) %>%
  mutate(case_type = "other") %>%
  select(case_number, case_type)

case_type_combined <- not_in_court_records %>%
  bind_rows(in_both) %>%
  bind_rows(not_in_ha_data) %>%
  group_by(case_type) %>%
  count() %>%
  pivot_wider(names_from = case_type, values_from=n) %>%
  mutate(total = non_payment_rent+other) %>%
  mutate(pct_nonpayment = round(non_payment_rent/total*100,2))

#Of those cases, how many fall into buckets of dollar amounts?

minneapolis_buckets_graphic <- minneapolis_eviction_records %>%
  filter(year > 2016) %>%
  mutate(rent_owed = case_when(
    case_number == "27-CV-HC-17-4855" ~ "0",
    case_number == "27-CV-HC-18-3593" ~ "1966",
    case_number == "27-CV-HC-18-3591" ~ "542",
    TRUE ~ rent_owed
  )) %>%
  mutate(rent_owed = as.numeric(rent_owed)) %>%
  mutate(amount_due_bucket = case_when(
    rent_owed == 0 ~ "N/A",
    rent_owed >= 1 & rent_owed < 100 ~ 'under_100',
    rent_owed >= 100 & rent_owed < 200 ~ 'under_200',
    rent_owed >= 200 & rent_owed < 300 ~ 'under_300',
    rent_owed >= 300 & rent_owed < 400 ~ 'under_400',
    rent_owed >= 400 & rent_owed < 500 ~ 'under_500',
    TRUE ~ "500_plus"
  )) %>%
  group_by(amount_due_bucket) %>%
  count()

#What was the average amount owed?

minneapolis_avg_owed_graphic <- minneapolis_eviction_records %>%
  filter(year > 2016) %>%
  mutate(rent_owed = case_when(
    case_number == "27-cv-hc-17-4855" ~ "0",
    case_number == "27-cv-hc-18-3593" ~ "1966",
    case_number == "27-cv-hc-18-3591" ~ "542",
    TRUE ~ rent_owed
  )) %>%
  filter(!case_number == "n/a") %>%
  filter(!case_number == "deceased/no service") %>%
  mutate(rent_owed = as.numeric(rent_owed)) %>%
  mutate(avg_owed = round(mean(rent_owed))) %>%
  summarise(avg_owed)

#What percent of defendants had attorneys?

minneapolis_attorney_graphic <- minneapolis %>%
  mutate(date_filed = mdy(date_filed)) %>%
  mutate(year = year(date_filed)) %>%
  filter(year > 2016) %>%
  mutate(def_has_attorney = case_when(
    defendant_attorney_one == "none" ~ "no_rep",
    defendant_attorney_one == "pro se" ~ "no_rep",
    TRUE ~ "yes_rep"
  )) %>%
  group_by(def_has_attorney) %>%
  count() %>%
  pivot_wider(names_from = def_has_attorney, values_from=n) %>%
  mutate(total = no_rep+yes_rep) %>%
  mutate(pct_attorney = round(yes_rep/total*100,2))

```

#### Oklahoma City

``` {r}

#How many cases were over nonpayment of rent? 

okc_nonpayment_graphic <- okc_records %>%
  filter(year.x > 2016) %>%
  group_by(reason_type) %>%
  count()

#What percentage of all cases was that? 
# **Sentence:** Correct as written

okc_nonpayment_graphic <- okc_records %>%
  filter(year.x > 2016) %>%
  group_by(reason_type) %>%
  count() %>%
  filter(n > 1) %>%
  pivot_wider(names_from=reason_type, values_from=n) %>%
  mutate(total = rent+other) %>%
  mutate(pct_rent = round(rent/total*100,2))

#Of those cases, how many fall into buckets of dollar amounts?

okc_buckets_graphic <- okc_rent %>%
  filter(year > 2016) %>%
  mutate(default_amount = as.character(default_amount)) %>%
  mutate(default_amount = case_when(
    default_amount == "n/a" ~ "",
    TRUE ~ default_amount
  )) %>%
  filter(default_amount!= "") %>%
  mutate(default_amount = str_remove(default_amount, "\\$"))%>%
  mutate(default_amount = as.numeric(default_amount)) %>%
  mutate(amount_due_bucket = case_when(
    default_amount == 0 ~ "N/A",
    default_amount >= 1 & default_amount < 100 ~ 'under_100',
    default_amount >= 100 & default_amount < 200 ~ 'under_200',
    default_amount >= 200 & default_amount < 300 ~ 'under_300',
    default_amount >= 300 & default_amount < 400 ~ 'under_400',
    default_amount >= 400 & default_amount < 500 ~ 'under_500',
    TRUE ~ "500_plus"
  )) %>%
  group_by(amount_due_bucket) %>%
  count()

#What was the average amount owed?

okc_amt_owed_avg_graphic <- okc_rent %>%
  filter(year > 2016) %>%
  mutate(default_amount = as.character(default_amount)) %>%
  mutate(default_amount = case_when(
    default_amount == "n/a" ~ "",
    TRUE ~ default_amount
  )) %>%
  filter(default_amount!= "") %>%
  mutate(default_amount = str_remove(default_amount, "\\$")) %>%
  mutate(default_amount = str_remove(default_amount, ",")) %>%
  mutate(default_amount = as.numeric(default_amount)) %>%
  summarise(avg_owed = round(mean(default_amount)))

#What percent of defendants had attorneys?

okc_attorney_graphic <- okcha_count %>%
  filter(year > 2016) %>%
  mutate(attorney_yes_no = case_when(
    str_detect(attorney_one_rep, "housing") ~ "no",
    attorney_one_rep == "none" ~ "no",
    is.na(attorney_one_rep) ~ "no",
    TRUE ~ "yes"
  )) %>%
  group_by(attorney_yes_no) %>%
  count() %>%
  pivot_wider(names_from = attorney_yes_no, values_from = n) %>%
  mutate(total = yes+no) %>%
  mutate(pct_attorney = yes/total*100)

```

#### Richmond

``` {r}

#How many cases were over nonpayment of rent? 

richmond_nonpayment_graphic <- richmond_records %>%
  filter(move_out_year > 2016) %>%
  group_by(reason_for_move_out) %>%
  count()

#what percentage of all cases was that? 
# filtering for previously established evict-able reasons
# confirm reasons with PHA
# **Sentence:** Of evictable moveout reasons documented by the Richmond Redevelopment & Housing Authority, 84% were for nonpayment of rent.

richmond_pct_nonpayment_graphic <- richmond_records %>%
  filter(move_out_year > 2016) %>%
  group_by(reason_for_move_out) %>%
   mutate(nonpayment_moveout = case_when(
    reason_for_move_out == "Nonpayment of Rent" ~ "yes",
    reason_for_move_out == "Fourth Late Notice" ~ "no",
    reason_for_move_out == "Lease violation-other" ~ "no",
    reason_for_move_out == "Criminal Activity" ~ "no",
    reason_for_move_out == "Drug-related Activity" ~ "no",
    reason_for_move_out == "Guns/Weapons" ~ "no",
    TRUE ~ "N/A"
  )) %>%
  group_by(nonpayment_moveout) %>%
  count() %>%
  filter(!nonpayment_moveout == "N/A") %>%
  pivot_wider(names_from = nonpayment_moveout, values_from=n) %>%
  mutate(total = yes+no) %>%
  mutate(pct_executed = round(yes/total*100,2))

#Of those cases, how many fall into buckets of dollar amounts?
# CHART TITLE: Judgement for Unpaid Rent

richmond_buckets_graphic <- richmond %>%
  filter(file_year > 2016) %>%
  mutate(principal_amount = as.numeric(principal_amount)) %>%
  mutate(amount_due_bucket = case_when(
    principal_amount == 0 ~ "N/A",
    principal_amount >= 1 & principal_amount < 100 ~ 'under_100',
    principal_amount >= 100 & principal_amount < 200 ~ 'under_200',
    principal_amount >= 200 & principal_amount < 300 ~ 'under_300',
    principal_amount >= 300 & principal_amount < 400 ~ 'under_400',
    principal_amount >= 400 & principal_amount < 500 ~ 'under_500',
    TRUE ~ "500_plus"
  )) %>%
  group_by(amount_due_bucket) %>%
  count()

#What was the average amount owed?
# CHART TITLE: Average Judgement for Unpaid Rent

richmond_amt_owed_avg_graphic <- richmond %>%
  filter(file_year > 2016) %>%
  mutate(principal_amount = as.numeric(principal_amount)) %>%
  filter(!principal_amount == 0) %>%
  summarise(avg_owed = round(mean(principal_amount)))

#What percent of defendants had attorneys?

richmond_rep_graphic <- richmond %>%
  filter(file_year > 2016) %>%
  mutate(defendant_has_rep = if_else(defendant_attorney_one == "none", "no", "yes")) %>%
  group_by(defendant_has_rep) %>%
  count() %>%
  pivot_wider(names_from = defendant_has_rep, values_from=n) %>%
  mutate(total = yes+no) %>%
  mutate(pct_rep = round(yes/total*100,2))

```

#### OKC Writs Compared To Other Counties

The purpose of this graphic is to show how many more writs Oklahoma City served than other counties. We chose to highlight 2019 because it's the most recent full year of data we have.

```{r warning=FALSE, message=FALSE}

# Crisfield

writ_graphic_crisfield <- somerset %>%
  filter(year == 2019) %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  mutate(writ_executed = case_when(
    warrant_outcome == "evicted" ~ "writ_executed",
    TRUE ~ "writ_not_executed"
  )) %>%
  group_by(writ_executed) %>%
  count() %>%
  pivot_wider(names_from = writ_executed, values_from=n) %>%
  mutate(total = writ_executed+writ_not_executed) %>%
  mutate(pct_executed = round(writ_executed/total*100,2))

#OKC

writ_graphic_okc <- okc_records %>%
  filter(year.x == 2019) %>%
  mutate(writ_executed = case_when(
    writ_executed == "none" ~ "writ_not_executed",
    TRUE ~ "writ_executed"
  )) %>%
  group_by(writ_executed) %>%
  count() %>%
  pivot_wider(names_from = writ_executed, values_from=n) %>%
  mutate(total = writ_executed+writ_not_executed) %>%
  mutate(pct_executed = round(writ_executed/total*100,2))

```

#### Crisfield Filing Rates

The purpose of this graphic is to show how much Crisfield's filings varied every year.

```{r warning=FALSE, message=FALSE}

crisfield_graphic <- somerset %>%
  filter(filing_date > "2016-12-31") %>%
  filter(str_detect(plaintiff, "cris")) %>%
  filter(!str_detect(title,"umes|UMES")) %>%
  filter(!str_detect(tenant_address_total,"umes blvd")) %>%
  filter(case_number != "d022lt20000833") %>%
  group_by(year) %>%
  count()

```

#### Charleston Multiple Filings

The purpose of this graphic is to highlight how many times the Housing Authority of the City of Charleston files against individual tenants. We cleaned the tenant names in Open Refine. We filtered for tenants who had at least 10 filings against them.

```{r warning=FALSE, message=FALSE}

# number of tenants with 10 or more filings

charleston_defendants_graphic <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(defendant_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  filter(total > 9) %>%
  group_by(total) %>%
  count()

# total number of tenants filed against

charleston_total_defendants_graphic <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(defendant_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  count()

# number of tenants with more than 2 filings

charleston_two_plus_defendants_graphic <- charleston_pha_all %>%
  mutate(year = year(date_filed)) %>%
  filter(!year %in% c("2015","2016")) %>%
  group_by(defendant_one_name) %>%
  summarise(total = n()) %>%
  arrange(desc(total)) %>%
  filter(total > 2) %>%
  summarise(total_multiple = n()) 

```
